<!DOCTYPE html>
<html>
  <head>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>
    <script src="https://unpkg.com/aframe-gesture-detector/dist/aframe-gesture-detector.min.js"></script>
  </head>
  <body style="margin: 0; overflow: hidden">
    <a-scene
      embedded
      renderer="antialias: true; precision: highp; logarithmicDepthBuffer: true;"
      vr-mode-ui="enabled: false"
      arjs="sourceType: webcam; debugUIEnabled: false;"
      gesture-detector
    >
      <!-- Script xử lý xoay bằng cảm ứng -->
      <script>
        AFRAME.registerComponent("rotate-and-zoom", {
          schema: {
            minScale: { default: 0.3 },
            maxScale: { default: 5 }
          },
          init: function () {
            this.rotation = this.el.getAttribute("rotation") || { x: 0, y: 0, z: 0 };
            this.scale = this.el.getAttribute("scale") || { x: 1, y: 1, z: 1 };
            this.start = { x: 0, y: 0 };
            this.isDragging = false;
            this.initialPinchDistance = null;
      
            const scene = this.el.sceneEl;
      
            const startDrag = (x, y) => {
              this.isDragging = true;
              this.start.x = x;
              this.start.y = y;
            };
      
            const moveDrag = (x, y) => {
              if (!this.isDragging) return;
              const dx = x - this.start.x;
              const dy = y - this.start.y;
      
              this.rotation.z += dx * 0.5; // Xoay Z
              this.rotation.x += dy * 0.5; // Xoay X
      
              this.el.setAttribute("rotation", this.rotation);
      
              this.start.x = x;
              this.start.y = y;
            };
      
            const endDrag = () => {
              this.isDragging = false;
            };
      
            // Chuột
            scene.addEventListener("mousedown", (e) => startDrag(e.clientX, e.clientY));
            window.addEventListener("mousemove", (e) => moveDrag(e.clientX, e.clientY));
            window.addEventListener("mouseup", endDrag);
      
            // Cảm ứng
            scene.addEventListener("touchstart", (e) => {
              if (e.touches.length === 1) {
                startDrag(e.touches[0].clientX, e.touches[0].clientY);
              } else if (e.touches.length === 2) {
                this.isDragging = false;
                this.initialPinchDistance = this.getPinchDistance(e);
              }
            });
      
            scene.addEventListener("touchmove", (e) => {
              if (e.touches.length === 1) {
                moveDrag(e.touches[0].clientX, e.touches[0].clientY);
              } else if (e.touches.length === 2) {
                const newDist = this.getPinchDistance(e);
                const zoomFactor = newDist / this.initialPinchDistance;
                this.applyZoom(zoomFactor);
                this.initialPinchDistance = newDist;
              }
            });
      
            scene.addEventListener("touchend", endDrag);
      
            // Wheel zoom (chuột)
            scene.addEventListener("wheel", (e) => {
              const zoomFactor = e.deltaY < 0 ? 1.1 : 0.9;
              this.applyZoom(zoomFactor);
            });
          },
      
          getPinchDistance: function (e) {
            const dx = e.touches[0].clientX - e.touches[1].clientX;
            const dy = e.touches[0].clientY - e.touches[1].clientY;
            return Math.sqrt(dx * dx + dy * dy);
          },
      
          applyZoom: function (factor) {
            const newScale = this.scale.x * factor;
            const limited = Math.min(this.data.maxScale, Math.max(this.data.minScale, newScale));
            this.scale = { x: limited, y: limited, z: limited };
            this.el.setAttribute("scale", this.scale);
          }
        });
      </script>
      

      <!-- Marker -->
      <a-nft 
        type="nft" 
        url="nft/fset" 
        smooth="true" 
        smoothCount="10" 
        smoothTolerance="0.01" 
        smoothThreshold="5">
        <!-- Container xoay mô hình -->
        <a-entity id="model-container" rotation="0 0 0" rotate-and-zoom>
          <a-entity
            id="duck-model"
            gltf-model="a7.glb"
            position="0 0 0"
            scale="1 1 1"
            rotation="-90 0 0"
            shadow="cast: true; receive: false"
          ></a-entity>
        </a-entity>
      </a-nft>

      <a-entity camera></a-entity>
    </a-scene>
    </div>
  </body>
</html>
